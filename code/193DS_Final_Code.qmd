---
title: "193DS_Final_Code"
authors: Graycen Mahon, Benise Limon, Kiya Pupa
data: "2023-06-12"
output:
  html_document:
    code_folding: hide
---

# Problem 1

**Context:** Read Koontz and Simpson 2010, "The composition of seed banks on kangaroo rat (Dipodomys spectabilis) mounds in a Chihuahuan Desert grassland." Journal of Arid Environments. https://doi.org/10.1016/j.jaridenv.2010.03.008\
**Data:** Koontz, T. and H. Simpson. 2013. Effects of Kangaroo Rat Mounds on Seed Banks of Grass and Shrublands at the Sevilleta National Wildlife Refuge, New Mexico (2001) ver 102459. Environmental Data Initiative.\
https://doi.org/10.6073/pasta/115b8095a5e82028869a8c56eff14597\
**Question:** How does total seed number differ between kangaroo rat mound locations?

## Introduction

For the first data set which is the study of the effects of Kangaroo Rat Mounds on Seed Banks of Grass and Shrublands at the Sevilleta National Wildlife Refuge, New Mexico, we analyzed the data in order to answer the question, "How does the total seed number differ between kangaroo rat mound locations?". Studies have shown that rodents, such as kangaroo rats, are important in seed dispersal and therefore the survival of different plant species while reducing water usage in drought ridden areas (Beck). In areas with high rates of drought, and low rodent populations, seed dispersal is less productive and therefore many plant species become endangered. Drought causes a decrease in seed and plant release height, which decreases seed terminal velocity and therefore possibility of germination (Johnson et al). It is important to study the effectiveness of kangaroo rat seed dispersal and the content of seed banks on kangaroo rat mounds for ecological purposes. The results of this study will allow for a better understanding of whether or not kangaroo rats are beneficial or harmful to the longevity of plant species. 

Citations:
Beck, J Maurice. 30 August 2010. Seed Dispersal by Scatter-hoarding Rodents in Arid Environments (2010). British Ecological Society. https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/j.1365-2745.2010.01716.x

Johnson JS, Cantrell RS, Cosner C, Hartig F, Hastings A, Rogers HS, Schupp EW, Shea K, Teller BJ, Yu X, Zurell D, Pufal G. Rapid changes in seed dispersal traits may modify plant responses to global change. AoB Plants. 2019 Mar 28;11(3):plz020. doi: 10.1093/aobpla/plz020. PMID: 31198528; PMCID: PMC6548345. 

Koontz, T. and H. Simpson. 2013. Effects of Kangaroo Rat Mounds on Seed Banks of Grass and Shrublands at the Sevilleta National Wildlife Refuge, New Mexico (2001) ver 102459. Environmental Data Initiative. https://doi.org/10.6073/pasta/115b8095a5e82028869a8c56eff14597 (Accessed 2023-06-10).

## Methods (code):
○ Any cleaning and wrangling steps ✅
○ Assumption checks ✅
○ Statistical tests and null hypotheses ✅
○ Citations for packages, software, data, or other steps

H0: All ranks are equal (no difference in medians)
HA: At least two ranks differ (at least one difference in group medians)

```{r loading-in-packages1}
library(tidyverse)
library(here)
library(janitor)
library(ggeffects)
library(performance)
library(naniar) 
library(flextable)
library(car)
library(broom)
library(corrplot)
library(AICcmodavg)
library(GGally)
library(stats)
library(dplyr)
library(effsize)
library(rstatix)
```

```{r read-data}
# checking to make sure the "here" package is starting at the correct directory
here()

#reading in data set
krat <- read_csv(here("data/sev208_kratseedbank_20120213.csv"))
```

```{r miss-vis}
#visualizing missing observations
gg_miss_var(krat)
#nothing missing!
```

```{r explore-data}
# Exploring data with a bar graph
ggplot(data = krat, aes(x = loc, y = seeds)) +
  geom_col()
```


The only thing we did to wrangle the data was to select only the mound location and seed count fields that we needed for our analysis. 
```{r model-object}
# create a new object called krat subset 
krat_subset <- krat %>% 
  # select the columns of interest (mound location and seed count)
  dplyr::select("loc", "seeds") 
```

```{r}
# create a summary subset of the krat data grouped by location and calculate mean, standard deviation, variance, count, standard error, and margin of error for seeds for each location
krat_subset_summary <- krat_subset %>% 
  group_by(loc) %>% 
  summarize(mean = mean(seeds),
            median = median(seeds),
            sd = sd(seeds),
            var = var(seeds),
            count = length(seeds),
            se = sd/sqrt(count),
            margin = qt(0.975, df = count - 1) * se)

# Display summary statistics
krat_subset_summary
```


```{r check-normality}
#check the distribution of the data grouped by mound location
ggplot(data = krat_subset) +
  stat_qq(aes(sample = seeds)) + 
  stat_qq_line(aes(sample = seeds), color = "red") +
  facet_wrap(~ loc)
```
Distributions are not normal, all distributions look mostly like a flat line that increase exponentially/rapidly as you get more positive standard deviations away. Distributions are all similar. 

```{r}
# Using krat_subset as dataframe and dependent variable 'seeds' and a grouping variable 'loc'
library(car)

# Perform Levene's test
leveneTest(seeds ~ loc, data = krat_subset)
```

<<<<<<< HEAD
=======
* Random sampling: 10 active kangaroo mounds were randomly selected and 16 samples were collected per mound on the base of the mound and on the disturbed area surrounding the mound. 


Categorical predictor variables: The predictor variables are the mound location, which are categorical data because the mound locations are identified based on four different labels. 

Each group should have at least 5 observations: Yes. 

Running a Kruskal-Wallis test to compare the seed count data for four different locations around the mounds. The Kruskal-Wallis test is a non-parametric test used to compare the distributions of a continuous or discrete dependent variable across multiple independent groups. As a non-parametric test, it does not make strong assumptions about the shape or distribution of the data. However, there are some assumptions and considerations to keep in mind when conducting a Kruskal-Wallis test:
>>>>>>> aede35923c61547cd6e24399ec190d0aeb5779d5

```{r kruskal-test}
kruskal.test(seeds ~ loc, data = krat_subset)
```
very low p-value indicating seed count does differ between mound locations. 

```{r eta-squared}
# Comparison of ranks for Kruskal Wallis based on H statistic
rstatix::kruskal_effsize(seeds ~ loc, data = krat_subset)
```
small effect size (0.0128)

## Methods:

In order to properly analyze and organize the data set, we first began by reading in the data file using the csv function and saving data within an object named "krat"- as in Kangaroo Rat. Next, we made a missing data visualization of the krat data set so we could view the missing data from the frame. As seen in the visualization, there are no missing observations for the Kangaroo Rat data set. After determining this, we then created a data visualization using a bar graph with location of the kangaroo rat mound on the x axis and seed count on the y axis. The Kangaroo Rat data set is a chart of the observations made for the study with the columns being; mound (mnd), direction (dir), location (loc), species (species), and seed number (seeds). There are a total of 1560 observations, spanning different mounds and on a different location for each mound. The mound locations used for the study are as follows; around the base of the mound (B), surrounding area of the mount (D), edge of Bouteloua eriopoda grass (E) and the interspace between the Bouteloua eriopoda grass (I). In order to wrangle and clean the dataset to show only the observations needed for the purpose of our analysis, we created a krat_subset object and used the dplyr function to select the two columns of interest: seed count and location and omitted direction, mound and species. With the intention of answering the question “How does total seed number differ between kangaroo rat mound locations?”, we are only interested in seed count and location. To prepare to run statistical analysis on the dataframe, we then summarized the data by creating a new object called “krat_subset_summary” and grouping the following values by location: mean, median, standard deviation, variance, count, standard error, and margin of error. A data summary is used to help organize and visually understand the data for the frame in question. After summarizing the data, we created a plot of the krat_subset data to check for the normality of the data, and whether it had a normal distribution. As seen in the figure, data is not normally distributed which can make statistical analysis difficult. In order to properly test the data, we chose to run a Kruskal-Wallis test to compare the seed count data for the four different locations of interest (B, D, E, I). This test is a non-parametric test used to compare the distributions of a continuous or discrete dependent variable across multiple independent groups. As a non-parametric test, it does not make strong assumptions about the shape or distribution of the data. However, there are some assumptions and considerations to keep in mind when conducting a Kruskal-Wallis test:

1) Independent observations: Observations within each group (B, D, E, and I) are completely independent of each other. Observations in one group are not influenced by observations in any of the other groups.

2) Similar shape of distributions: Distribution shape was checked using a QQ-plot for each of the mound locations and all distributions were visually similar. All distributions look relatively flat without a strong linear relationship. However, after 2 standard deviations away from the mean, the data points rapidly increase.

3) Homogeneity of variances: If there is homogeneity of variances, the dependent variable across the groups being compared should be similar. 

4) Random Sampling: 10 active kangaroo mounds were randomly selected and 16 samples were collected per mound on the base of the mound and on the disturbed area surrounding the mound. 

The Kruskal Wallis test does not test for homogeneity, so we ran a levene test using seeds as the dependent variable and mound location as the grouping variable. The significant p-value of 2.66e-09 indicates that there is no homogeneity of variances, but, since the Kruskal-Wallis test is non-parametric, it is less sensitive to violations of this assumption and can still be used. After running these two tests, we then measured the effect size of the data set which informs us the significance of the relationship between our variables on a numerical scale, and therefore how important and applicable it is to the “real world”. 

## Results

○ Interpretation of main results in the context of the system\
○ Relevant test statistics, degrees of freedom, p-values, significance levels, etc.\
○ A visualization of some kind reflecting the analysis you did (comparison of groups and/or relationships between variables) with a caption\
○ A table (if appropriate) with a caption

# Problem 2

**Data:** Seaver, M. 2022. Individual and community flowering phenology, seed counts and pollinator\
visitation rates in shrub and open plots across Niwot Ridge, 2019 - 2021. ver 1. Environmental Data Initiative. https://doi.org/10.6073/pasta/edc4ab2faf7dd96cd1deac1544d5f2b9\
**Questions:** How does seed count vary with plot type (shrub or open), plant species, and total number of inflorescences? Is there a simpler model that explains seed count, and if so, what is it?

## Introduction

<<<<<<< HEAD
○ To your specific analysis (biology or otherwise) with 3-5 citations (3-5 sentences)

  For the second data set, which is the study of individual and community flowering phenology, seed counts and pollinator visitation rates in shrub and open plots across Niwot Ridge (the arctic tundra) we analyzed the data in order to answer the questions, "How does seed count vary with plot type (shrub or open), plant species, and total number of inflorescences? Is there a simpler model that explains seed count, and if so, what is it?". Studies show that increased shrub abundance can lead to increased levels of snow which can allow for "higher winter soil temperatures, greater microbial activity, and more plant-available nitrogen. High levels of soil nitrogen favor shrub growth the following summer" (Sturm et al). Each of these characteristics can lead to increased growth in spring and summer, altering species richness and plant community composition. According to Seaver's study from the Environmental Data Initiative, this can therefore effect the reproductive success of plants, which is studied through phenology- the timing of flowering in plants (Seaver). Flowering times are affected by surrounding plant and insect species, and studies show that the most common flowering time of plants is during seasons with higher biodiversity. Increased shrubs would indicate higher rates of flowering. 
=======
For the second data set, which is the study of individual and community flowering phenology, seed counts and pollinator visitation rates in shrub and open plots across Niwot Ridge (the arctic tundra) we analyzed the data in order to answer the questions, "How does seed count vary with plot type (shrub or open), plant species, and total number of inflorescences? Is there a simpler model that explains seed count, and if so, what is it?". Studies show that increased shrub abundance can lead to increased levels of snow which can allow for "higher winter soil temperatures, greater microbial activity, and more plant-available nitrogen. High levels of soil nitrogen favor shrub growth the following summer" (Sturm et al). Each of these characteristics can lead to increased growth in spring and summer, altering species richness and plant community composition. According to Seaver's study from the Environmental Data Initiative, this can therefore effect the reproductive success of plants, which is studied through phenology- the timing of flowering in plants (Seaver). Flowering times are affected by surrounding plant and insect species, and studies show that the most common flowering time of plants is during seasons with higher biodiversity. Increased shrubs would indicate higher rates of flowering. 
>>>>>>> aede35923c61547cd6e24399ec190d0aeb5779d5

Citations:

Matthew Sturm and others, Winter Biological Processes Could Help Convert Arctic Tundra to Shrubland, BioScience, Volume 55, Issue 1, January 2005, Pages 17–26, https://doi.org/10.1641/0006-3568(2005)055[0017:WBPCHC]2.0.CO;2

Seaver, M. 2022. Individual and community flowering phenology, seed counts and pollinator visitation rates in shrub and open plots across Niwot Ridge, 2019 - 2021. ver 1. Environmental Data Initiative. https://doi.org/10.6073/pasta/edc4ab2faf7dd96cd1deac1544d5f2b9 (Accessed 2023-06-10).

Wolf, A Amelia and others. Flowering Phenology shifts in Response to Biodiversity Loss (13 March 2017). National Academy of Science. Carnegie Institution of Washington, Stanford, CA. https://www.pnas.org/doi/10.1073/pnas.1608357114 

## Methods

  For the second problem, we began by reading in the csv file and naming a new object called seed. In order to 

○ Any cleaning and wrangling steps\
○ Assumption checks\
○ Statistical tests and null hypotheses\
○ Citations for packages, software, data, or other steps

```{r}
#packages for model
library(MASS)
library(lme4)
library(glmmTMB)

library(DHARMa)
library(MuMIn)
library(ggeffects)
library(lmtest)
library(broom)

library(tidyverse)
library(here)
library(naniar)
library(skimr)
library(GGally)
library(flextable)
```

Redoing problem 2 based on workshop 10
```{r knitr-example, eval = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
# suppress any messages from R using the code chunk above, setting messages and warnings to false}
```

```{r reading-in-the-dataset}
#reading in the data sets for problem 2
seed_1 <- read_csv(here("data/shrubstudy_seed_ctwt.ms.data.csv"))
```

```{r missing-data-visualization}
gg_miss_var(seed_1) +
  labs(caption = "Missing Data in the Seed Dataset") +
  theme(plot.caption = element_text(hjust = 0.6))

skim(seed_1)
```

```{r making-a-ggpairs-plot}
seed_1 %>% 
  dplyr::select(!species) %>% 
  ggpairs()
# make a ggpairs plot to show the relationship between variables using the seed data set
```


```{r cleaning-up-the-data}
#cleaning and sub-setting data
#selecting columns to have in data frame
seed_subset1 <- seed_1 %>%
  dplyr::select(species, treatment, nr_seeds, total_nr_infl, nr_infl_coll)

seed_col0 <- seed_subset1
seed_1[is.na(seed_1) | seed_1 == "Inf"] <- NA 

seed_col1 <- seed_col0 %>% 
  drop_na(nr_seeds)


#seed_col <- seed_subset1
#seed_subset1[is.na(seed_subset1) | seed_subset1 == "Inf"] <- NA 

seed_col2 <- seed_1
seed_1[is.na(seed_1) | seed_1 == "Inf"] <- NA 

seed_col3 <- seed_col2 %>% 
  drop_na(nr_seeds)

#seed_col1
seed_col3
```

```{r data-visualization}
ggplot(seed_col1, aes(x = nr_seeds)) +
  geom_histogram(bins = 7)
```

```{r}
#this is a linear model that we know is wrong
seed_mod1 <- lm(nr_seeds ~ species + total_nr_infl + treatment, data = seed_col1)

#generalized linear model with Poisson distribution
seed_mod2 <- glm(nr_seeds ~ species + total_nr_infl + treatment, data = seed_col1, family = "poisson")
seed_mod2.a <- glm(nr_seeds ~ species + total_nr_infl + treatment, data = seed_col1, family = "poisson")
                                
#generalized linear model with negative binomial distribution
seed_mod3 <- glm.nb(nr_seeds ~ species + total_nr_infl + treatment, data = seed_col1)
seed_mod3.a <- glmmTMB(nr_seeds ~ species + total_nr_infl + treatment, data = seed_col1, family = "nbinom2")
#best

#generalized linear model with Poisson distribution and random effect of site
seed_mod4 <- glmer(nr_seeds ~ species + total_nr_infl + treatment + (1|nr_infl_coll), data = seed_col1, family = "poisson")
seed_mod4.a <- glmmTMB(nr_seeds ~ species + total_nr_infl + treatment + (1|nr_infl_coll), data = seed_col1, family = "poisson")
#use species or treatment for random effect???

#generalized linear model with negative binomial distribution and random effect of site
seed_mod5 <- glmer.nb(nr_seeds ~ species + total_nr_infl + treatment + (1|nr_infl_coll), data = seed_col1)
seed_mod.a <- glmmTMB(nr_seeds ~ species + total_nr_infl + treatment + (1|nr_infl_coll), data = seed_col1, family = "nbinom2") 

#error for last few models, need numeric data?
```

Look at Residuals
```{r diagnostics-model-2}
plot(simulateResiduals(seed_mod2))
```

```{r diagnostics-model-3}
plot(simulateResiduals(seed_mod3))
```

```{r diagnostics-model-4}
plot(simulateResiduals(seed_mod4))
```

```{r diagnostics-model-5}
plot(simulateResiduals(seed_mod5))
```

```{r diagnostics-model-a}
plot(simulateResiduals(seed_mod.a))
```

```{r testing-distributions-for-validity}
#Which distribution to use?
MuMIn::model.sel(seed_mod1, seed_mod2, seed_mod3, seed_mod4, seed_mod5, seed_mod.a)
```

```{r viewing-the-model-object}
#model object
seed_mod3
```

```{r summarizing-the-model-object}
summary(seed_mod3)
```

```{r defining-confidence-intervals}
#confidence intervals
confint(seed_mod3)
```

```{r}
#adjusted R2
r.squaredGLMM(seed_mod3)
# error message: the null model is correct only if all variables used by the original model remain unchanged. 
```

```{r}
#model object in table 
seed_mod3 %>% 
  as_flextable()
```

```{r}
seed_predictions <- ggpredict(seed_mod3, terms = c("total_nr_infl", "treatment",  "species")) %>% 
  rename(treatment = group,
         species = facet)
seed_predictions

ggplot(seed_mod3, aes(x = total_nr_infl, y = nr_seeds, fill = treatment)) +
  geom_point(aes(color = treatment), alpha = 0.5) +
  facet_wrap(~species, scales = "free_y") +
  geom_line(data = seed_predictions, aes(x = x, y = predicted, color = treatment)) + geom_ribbon(data = seed_predictions, aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high, fill = treatment), alpha = 0.2) +
  scale_fill_manual(values = c("shrub" = "blue", "control" = "orange")) +
  scale_color_manual(values = c("shrub" = "blue", "control" = "orange")) +
  theme_bw() +
  facet_wrap(~species, scales = "free_y") +
  labs(fill = "Mined", color = "Mined")

seed_mod4.a <- glmmTMB(nr_seeds ~ species + total_nr_infl + treatment + (1|treatment), data = seed_col1, family = "poisson")
```

## This is where our second attempt starts (stored in test code)


## Results
○ Interpretation of main results in the context of the system
○ Relevant test statistics, degrees of freedom, p-values, significance levels, etc.
○ A visualization of some kind reflecting the analysis you did (comparison of groups and/or relationships between variables) with a caption
○ A table (if appropriate) with a caption
