---
title: "193DS_Final_Code"
authors: Graycen Mahon, Benise Limon, Kiya Pupa
data: "2023-06-12"
output:
  html_document:
    code_folding: hide
---

# Problem 1

**Context:** Read Koontz and Simpson 2010, "The composition of seed banks on kangaroo rat (Dipodomys spectabilis) mounds in a Chihuahuan Desert grassland." Journal of Arid Environments. https://doi.org/10.1016/j.jaridenv.2010.03.008\
**Data:** Koontz, T. and H. Simpson. 2013. Effects of Kangaroo Rat Mounds on Seed Banks of Grass and Shrublands at the Sevilleta National Wildlife Refuge, New Mexico (2001) ver 102459. Environmental Data Initiative.\
https://doi.org/10.6073/pasta/115b8095a5e82028869a8c56eff14597\
**Question:** How does total seed number differ between kangaroo rat mound locations?

## Introduction

○ To your specific analysis (biology or otherwise) with 3-5 citations (3-5 sentences)

For the first data set which is the study of the effects of Kangaroo Rat Mounds on Seed Banks of Grass and Shrublands at the Sevilleta National Wildlife Refuge, New Mexico, we analyzed the data in order to answer the question, "How does the total seed number differ between kangaroo rat mound locations?". Studies have shown that rodents, such as kangaroo rats, are important in seed dispersal and therefore the survival of different plant species while reducing water usage in drought ridden areas (Beck). In areas with high rates of drought, and low rodent populations, seed dispersal is less productive and therefore many plant species become endangered. Drought causes a decrease in seed and plant release height, which decreases seed terminal velocity and therefore possibility of germination (Johnson et al). It is important to study the effectiveness of kangaroo rat seed dispersal and the content of seed banks on kangaroo rat mounds for ecological purposes. The results of this study will allow for a better understanding of whether or not kangaroo rats are beneficial or harmful to the longevity of plant species. 

Citations:
Beck, J Maurice. 30 August 2010. Seed Dispersal by Scatter-hoarding Rodents in Arid Environments (2010). British Ecological Society. https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/j.1365-2745.2010.01716.x

Johnson JS, Cantrell RS, Cosner C, Hartig F, Hastings A, Rogers HS, Schupp EW, Shea K, Teller BJ, Yu X, Zurell D, Pufal G. Rapid changes in seed dispersal traits may modify plant responses to global change. AoB Plants. 2019 Mar 28;11(3):plz020. doi: 10.1093/aobpla/plz020. PMID: 31198528; PMCID: PMC6548345. 

Koontz, T. and H. Simpson. 2013. Effects of Kangaroo Rat Mounds on Seed Banks of Grass and Shrublands at the Sevilleta National Wildlife Refuge, New Mexico (2001) ver 102459. Environmental Data Initiative. https://doi.org/10.6073/pasta/115b8095a5e82028869a8c56eff14597 (Accessed 2023-06-10).

## Methods
○ Any cleaning and wrangling steps
○ Assumption checks
○ Statistical tests and null hypotheses
○ Citations for packages, software, data, or other steps

```{r loading-in-packages1}
library(tidyverse)
library(here)
library(janitor)
library(ggeffects)
library(performance)
library(naniar) 
library(flextable)
library(car)
library(broom)
library(corrplot)
library(AICcmodavg)
library(GGally)
library(stats)
library(dplyr)
library(effsize)
library(rstatix)
```

## Exercise 1

```{r read-data}
# checking to make sure the "here" package is starting at the correct directory
here()

#reading in data set
krat <- read_csv(here("data/sev208_kratseedbank_20120213.csv"))
```

```{r miss-vis}
#visualizing missing observations
gg_miss_var(krat)
#nothing missing!
```

```{r explore-data}
# Exploring data with a bar graph 
ggplot(data = krat, aes(x = loc, y = seeds)) +
  geom_col()
```

```{r select-data}
# wrangling data to create a new object called krat_subset and select the columns of interest (location and seeds)
krat_subset <- krat %>% 
  dplyr::select("loc", "seeds") 
```

```{r data-summary}
# create a summary subset of the krat data grouped by location
# calculate mean, standard deviation, variance, count, standard error, and margin of error for seeds for each location
krat_subset_summary <- krat_subset %>%
group_by(loc) %>%
summarize(
  mean = mean(seeds),
  median = median(seeds),
  sd = sd(seeds),
  var = var(seeds),
  count = length(seeds),
  se = sd/sqrt(count),
  margin = qt(0.975, df = count - 1) * se)

krat_subset_summary
```


```{r check-normality}
ggplot(data = krat_subset) +
  stat_qq(aes(sample = seeds)) + 
  stat_qq_line(aes(sample = seeds), color = "red") +
  facet_wrap(~ loc)
```

Poisson 

```{r}
poisson.test(1560, T = 4, r = 1,
    alternative = c("greater"),
    conf.level = 0.95)
```


```{r}
rpois(1560, lambda)
```

Running a Kruskal-Wallis test to compare the seed count data for four different locations around the mounds 

```{r kruskal-test}
# Perform Kruskal-Wallis test to compare the difference in medians using a ranked-sign test
kruskal.test(seeds ~ loc, data = krat_subset)
```


```{r eta-squared}
# Comparison of ranks for Kruskal-Wallis test based on H statistic
rstatix::kruskal_effsize(seeds ~ loc, data = krat_subset)
```
small effect size (0.0122)

## Results

○ Interpretation of main results in the context of the system\
○ Relevant test statistics, degrees of freedom, p-values, significance levels, etc.\
○ A visualization of some kind reflecting the analysis you did (comparison of groups and/or relationships between variables) with a caption\
○ A table (if appropriate) with a caption

# Problem 2

**Data:** Seaver, M. 2022. Individual and community flowering phenology, seed counts and pollinator\
visitation rates in shrub and open plots across Niwot Ridge, 2019 - 2021. ver 1. Environmental Data Initiative. https://doi.org/10.6073/pasta/edc4ab2faf7dd96cd1deac1544d5f2b9\
**Questions:** How does seed count vary with plot type (shrub or open), plant species, and total number of inflorescences? Is there a simpler model that explains seed count, and if so, what is it?

## Introduction

○ To your specific analysis (biology or otherwise) with 3-5 citations (3-5 sentences)

For the second data set, which is the study of individual and community flowering phenology, seed counts and pollinator visitation rates in shrub and open plots across Niwot Ridge (the arctic tundra) we analyzed the data in order to answer the questions, "How does seed count vary with plot type (shrub or open), plant species, and total number of inflorescences? Is there a simpler model that explains seed count, and if so, what is it?". Studies show that increased shrub abundance can lead to increased levels of snow which can allow for "higher winter soil temperatures, greater microbial activity, and more plant-available nitrogen. High levels of soil nitrogen favor shrub growth the following summer" (Sturm et al). Each of these characteristics can lead to increased growth in spring and summer, altering species richness and plant community composition. According to Seaver's study from the Environmental Data Initiative, this can therefore effect the reproductive success of plants, which is studied through phenology- the timing of flowering in plants (Seaver). Flowering times are affected by surrounding plant and insect species, and studies show that the most common flowering time of plants is during seasons with higher biodiversity. Increased shrubs would indicate higher rates of flowering. 

Citations:

Matthew Sturm and others, Winter Biological Processes Could Help Convert Arctic Tundra to Shrubland, BioScience, Volume 55, Issue 1, January 2005, Pages 17–26, https://doi.org/10.1641/0006-3568(2005)055[0017:WBPCHC]2.0.CO;2

Seaver, M. 2022. Individual and community flowering phenology, seed counts and pollinator visitation rates in shrub and open plots across Niwot Ridge, 2019 - 2021. ver 1. Environmental Data Initiative. https://doi.org/10.6073/pasta/edc4ab2faf7dd96cd1deac1544d5f2b9 (Accessed 2023-06-10).

Wolf, A Amelia and others. Flowering Phenology shifts in Response to Biodiversity Loss (13 March 2017). National Academy of Science. Carnegie Institution of Washington, Stanford, CA. https://www.pnas.org/doi/10.1073/pnas.1608357114 

## Methods

  For the second problem, we began by reading in the csv file and naming a new object called seed. In order to 

○ Any cleaning and wrangling steps\
○ Assumption checks\
○ Statistical tests and null hypotheses\
○ Citations for packages, software, data, or other steps

```{r}
#packages for model
library(MASS)
library(lme4)
library(glmmTMB)

library(DHARMa)
library(MuMIn)
library(ggeffects)
library(lmtest)
library(broom)

library(tidyverse)
library(here)
library(naniar)
library(skimr)
library(GGally)
library(flextable)
```

Redoing problem 2 based on workshop 10
```{r knitr-example, eval = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
# suppress any messages from R using the code chunk above, setting messages and warnings to false}
```

```{r reading-in-the-dataset}
#reading in the data sets for problem 2
seed_1 <- read_csv(here("data/shrubstudy_seed_ctwt.ms.data.csv"))
```

```{r}
gg_miss_var(seed_1) +
  labs(caption = "Missing Data in the Seed Dataset") +
  theme(plot.caption = element_text(hjust = 0.6))

skim(seed_1)
```

```{r}
seed_1 %>% 
  dplyr::select(!species) %>% 
  ggpairs()
# make a ggpairs plot to show the relationship between variables using the seed data set
```


```{r}
#cleaning and sub-setting data
#selecting columns to have in data frame
coseed_subset1 <- seed_1 %>%
  dplyr::select(species, treatment, nr_seeds, total_nr_infl, shrub_num)


#seed_col <- seed_subset1
#seed_subset1[is.na(seed_subset1) | seed_subset1 == "Inf"] <- NA 

seed_col2 <- seed_1
seed_1[is.na(seed_1) | seed_1 == "Inf"] <- NA 

seed_col3 <- seed_col2 %>% 
  drop_na(nr_seeds)

seed_col1
```

```{r}
ggplot(seed_col1, aes(x = nr_seeds)) +
  geom_histogram(bins = 7)
```

```{r}
#this is a linear model that we know is wrong
seed_mod1 <- lm(nr_seeds ~ species + total_nr_infl + treatment, data = seed_col1)

#generalized linear model with Poisson distribution
seed_mod2 <- glm(nr_seeds ~ species + total_nr_infl + treatment, data = seed_col1, family = "poisson")
seed_mod2.a <- glm(nr_seeds ~ species + total_nr_infl + treatment, data = seed_col1, family = "poisson")
                                
#generalized linear model with negative binomial distribution
seed_mod3 <- glm.nb(nr_seeds ~ species + total_nr_infl + treatment, data = seed_col1)
seed_mod3.a <- glmmTMB(nr_seeds ~ species + total_nr_infl + treatment, data = seed_col1, family = "nbinom2")

#generalized linear model with Poisson distribution and random effect of site
seed_mod4 <- glmer(nr_seeds ~ species + total_nr_infl + treatment + (1|nr_infl_coll), data = seed_col3, family = "poisson")
seed_mod4.a <- glmmTMB(nr_seeds ~ species + total_nr_infl + treatment + (1|nr_infl_coll), data = seed_col3, family = "poisson")
#use species or treatment for random effect???

#generalized linear model with negative binomial distribution and random effect of site
seed_mod5 <- glmer.nb(nr_seeds ~ species + total_nr_infl + treatment + (1|nr_infl_coll), data = seed_col3)
seed_mod.a <- glmmTMB(nr_seeds ~ species + total_nr_infl + treatment + (1|nr_infl_coll), data = seed_col3, family = "nbinom2") 

#error for last few models, need numeric data?
```


Look at Residuals
```{r diagnostics}
plot(simulateResiduals(seed_mod2))
```

```{r}
plot(simulateResiduals(seed_mod3))
```

```{r}
plot(simulateResiduals(seed_mod4))
```

```{r}
plot(simulateResiduals(seed_mod5))
```

```{r}
plot(simulateResiduals(seed_mod55))
```

```{r}
#Which distribution to use?
MuMIn::model.sel(seed_mod1, seed_mod2, seed_mod3, seed_mod4, seed_mod5, seed_mod55)
```

```{r}
#model object
seed_mod3
```

```{r}
summary(seed_mod3)
```

```{r}
#confidence intervals
confint(seed_mod3)
```

```{r}
#adjusted R2
r.squaredGLMM(seed_mod3)
```

```{r}
#model object in table 
seed_mod3 %>% 
  as_flextable()
```

```{r}
seed_predictions <- ggpredict(seed_mod3, terms = c("species", "total_nr_infl", "treatment")) %>% 
  rename(treatment = group,
         species = facet)

seed_predictions

ggplot(seed_mod3, aes(x = total_nr_infl, y = nr_seeds, fill = treatment)) +
  geom_point(aes(color = treatment), alpha = 0.5) +
  facet_wrap(~species, scales = "free_y") +
  geom_line(data = seed_predictions, aes(x = x, y = Predicted, color = treatment)) +
  geom_ribbon(data = seed_predictions, aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high, fill = mined), alpha = 0.2) +
  scale_fill_manual(values = c("yes" = "blue", "no" = "orange")) +
  scale_color_manual(values = c("yes" = "blue", "no" = "orange")) +
  theme_bw() +
  facet_wrap(~species, scales = "free_y") +
  labs(fill = "Mined", color = "Mined")

seed_mod4.a <- glmmTMB(nr_seeds ~ species + total_nr_infl + treatment + (1|treatment), data = seed_col1, family = "poisson")

```

## This is where our second attempt starts















```{r knitr-example, eval = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
# suppress any messages from R using the code chunk above, setting messages and warnings to false}
```

```{r reading-in-the-dataset}
#reading in the data sets for problem 2
seed <- read_csv(here("data/shrubstudy_seed_ctwt.ms.data.csv"))
```

```{r cleaning-the-data}
seed %>% 
  #cleaning names
  clean_names()
  #creating new dataframe with columns
seed_col <- seed %>% 
  #selecting columns to have in data frame
  select(species, treatment, nr_seeds, total_nr_infl)
```

```{r missing-data-visualization-(1-4)}
#visualizing miss data points in seeds dataset
gg_miss_var(seed) +
  labs(caption = "Missing Data in the Seed Dataset") +
  theme(plot.caption = element_text(hjust = 0.6))
```

```{r}
#creating a seed subset object and dropping na values from the table
seed_subset <- seed_col
seed_subset[is.na(seed_subset) | seed_subset == "Inf"] <- NA 
seed_subset <- seed_col %>% 
  drop_na(nr_seeds)

#visualize missing data
gg_miss_var(seed_subset) +
  labs(caption = "Missing Data in the Seed Subset") +
  theme(plot.caption = element_text(hjust = 0.6))
#seed_subset$nr_seeds = as.numeric(as.character(seed_subset$nr_seeds)) 

```

```{r null-and-full-models}
#null model assigns the value of the predicted variable, seeds, to 1 so it is being modeled as a function of a constant term
null <- lm(nr_seeds ~ 1, data = seed_subset)
#full models includes all variables to assess a linear relationship between each predictor variable and seeds
full <- lm(nr_seeds ~ species + total_nr_infl + treatment, data = seed_subset)
```

```{r}
#create linear model for null model, make all graphs fit into pone 
null_model <- lm(nr_seeds ~ 1, data = seed_subset)
par(mfrow = c(2, 2))
#plot full linear model
plot(full)
```

```{r}
#Shapiro-Wilk test 
check_normality(full)
#Breusch-Pagan test
check_heteroscedasticity(full)
```

```{r}
#create a new model taking the log of the relationship between total mass and species type
#full_log <- lm(log(nr_seeds + .000000000000000000000000000000001) ~ species + total_nr_infl + treatment, data = seed_subset)

full_log <- lm(log(nr_seeds + min(nr_seeds[nr_seeds > 0])) ~ species + total_nr_infl + treatment, data = seed_subset)

#plotting to visually assess normality and homoscedasticity, making all four graphs on one page
par(mfrow = c(2, 2))
#plot full graph
plot(full_log)
```

```{r}
#Shapiro-Wilk test 
check_normality(full_log)
#Breusch-Pagan test
check_heteroscedasticity(full_log)
```

```{r explore-data-species}
ggplot(data = seed_subset, aes(x = species, y = nr_seeds), na.rm = TRUE) + geom_col()
```

```{r explore-data-inflorescences}
ggplot(data = seed_subset, aes(x = total_nr_infl, y = nr_seeds), na.rm = TRUE) + geom_col()
```

```{r explore-data plot type}
ggplot(data = seed_subset, aes(x = treatment, y = nr_seeds), na.rm = TRUE) + geom_col()
```

```{r}
#storing our summary model as an object 
model_summary <- summary(full)
#storing ANOVA table as an object
model_anova <- anova(full)

#displaying results from summary using the model object
model_summary
model_anova
```

```{r}
#creating a table that summarizes the anova table 
model_anova_table <- tidy(model_anova) %>% 
    #rounding the statistics, sum of mean squares and sum of squares, to two digits
    mutate(across(sumsq:meansq, ~ round(.x, digits = 2))) %>% 
    #round the F-statistic value to have 2 digits
    mutate(statistic = round(statistic, digits = 2)) %>% 
    ##replace the p value with < 0.001 rather than a super small number
    mutate(p.value = case_when(p.value < 0.001 ~ "< 0.001")) %>% 
    #rename the length to be more proper
    mutate(term = case_when(term == "length" ~ "Length", TRUE ~ term)) %>% 
    #create a flex table object from the data frame
    flextable() %>% 
    # change the header labels to be meaningful??
    set_header_labels(df = "Degrees of Freedom", 
                    sumsq = "Sum of Squares",
                    meansq = "Mean Squares",
                    statistic = "F-statistic",
                    p.value = "P-value")

model_anova_table
```

```{r}
#creating a summary table
table <- tidy(model_summary, conf.int = TRUE, exponentiate = TRUE) %>% 
#change low p-values to .001, change all values to round to 3 digits using mutate function
  mutate(statistic = round(statistic, digits = 3)) %>%
  mutate(std.error = round(std.error, digits = 3)) %>%
  mutate(conf.low = round(conf.low, digits = 3)) %>%
  mutate(conf.high = round(conf.high, digits = 3)) %>%
  mutate(estimate = round(estimate, digits = 3)) %>%
  mutate(p.value = case_when(p.value < 0.001 ~ "< 0.001")) %>% 
#create flextable
  flextable() %>% 
#fitting table to viewer
  autofit()
#show table 
  table
```

## Results
○ Interpretation of main results in the context of the system
○ Relevant test statistics, degrees of freedom, p-values, significance levels, etc.
○ A visualization of some kind reflecting the analysis you did (comparison of groups and/or relationships between variables) with a caption
○ A table (if appropriate) with a caption
